---
description: Historical context for past issues, decisions, and pitfalls
globs: "**/*.{ts,tsx}"
alwaysApply: true
---

# Historical Context

This file documents past issues and architectural decisions to prevent repeating mistakes.

## 1. MapCanvas.test.tsx Pre-existing Type Errors

**Issue:** `MapCanvas.test.tsx` had pre-existing TypeScript errors (`Cannot find name 'afterAll'`, `Cannot find name 'MapMouseEvent'`).

**Status:** Resolved. The pre-commit hook filter has been removed.

## 2. `next lint` Fails on Paths with Spaces

**Issue:** `next lint` cannot parse project directories containing spaces in the path (e.g. `/Users/.../Project Constellation/`). It throws `Invalid project directory provided`.

**Workaround:** Pre-commit hook uses `npx tsc --noEmit` and `npm run test:run` instead of `next lint`. Linting runs in CI via `npm run lint` where the checkout path has no spaces.

**Status:** Known Next.js issue; no upstream fix available.

## 3. ResizeObserver Not Available in jsdom

**Issue:** Components using `ResizeObserver` (e.g. `LgaBottomSheet`) crash in Vitest/jsdom with `ReferenceError: ResizeObserver is not defined`.

**Fix:** A polyfill is registered in `tests/setup.ts`:
```typescript
if (typeof globalThis.ResizeObserver === "undefined") {
  globalThis.ResizeObserver = class ResizeObserver { ... };
}
```

**Rule:** When adding new browser APIs to components, check jsdom support and add polyfills to `tests/setup.ts` as needed.

## 4. Absolute-to-Flex Layout Bug (Map + Bottom Sheet)

**Issue:** The `LgaBottomSheet` was initially implemented with `absolute bottom-0` positioning, which overlaid the map without resizing it. The map content was hidden behind the sheet.

**Root cause:** Absolute-positioned children do not affect parent/sibling layout. The map kept its full height while the sheet covered the lower portion.

**Fix:** Changed to a flex column layout where the map is `flex-1 min-h-0` and the bottom sheet is `shrink-0`. The map now resizes dynamically.

**Rule:** See `layout-contracts.mdc` for the full checklist.

## 5. GeoJSON Data Sources for QLD LGAs

**Decision:** After testing QLD OpenDataSoft (incomplete), QLD ArcGIS REST (naming issues), and ABS ASGS 2021 (correct), we settled on the ABS ASGS LGA_GEN dataset for land-clipped, generalised LGA boundaries.

**Key detail:** ABS uses simplified names (e.g. "Mackay" not "Mackay Regional"). The fetch script in `scripts/fetch-lga-boundaries.mjs` handles this mapping.

## 6. Vitest Mock Typing

**Issue:** `vi.fn()` returns `Mock<Procedure | Constructable>` which does not satisfy `() => void` prop types, causing `TS2322` errors.

**Fix:** Type the mock variable explicitly:
```typescript
// ❌ BAD
const onClose = vi.fn();

// ✅ GOOD
const onClose: () => void = vi.fn();
```

## 7. Vitest 4.x Process Hang on Node 24 (Known Bug)

**Issue:** Vitest 4.x (tested with v4.0.18) on Node 24 hangs indefinitely after all tests complete. The `startVitest()` Node API never resolves, `vitest.close()` blocks forever, and even `process.exit()` is intercepted by the `signal-exit` module. Setting `forceExit: true`, changing pool type (`threads`/`forks`), and adjusting `teardownTimeout` all fail to fix it.

**Root cause:** Lingering internal handles in Vitest's Vite server or file watcher system. This is a known upstream issue (see vitest-dev/vitest discussions).

**Fix:** `scripts/vitest-run.mjs` spawns vitest as a child process and monitors stdout. When output goes silent for 5 seconds after test results are seen, the wrapper SIGKILL's the child and exits with the correct code. The `test:run` npm script uses this wrapper.

**Rule:** Do NOT change `test:run` back to `vitest run` directly. If Vitest is upgraded and the hang is fixed upstream, the wrapper can be removed.

**Status:** Workaround in place; monitor Vitest releases for upstream fix.

## 8. Prisma Migration Drift on Local Dev DB

**Issue:** Running `prisma migrate dev` creates migration files and applies them to the local DB. If those files are later removed (squash, cleanup, or git reset), the local DB remembers them but the directory doesn't, causing permanent drift. Subsequent `prisma migrate dev --create-only` refuses to run.

**Root cause:** Prisma tracks applied migrations in `_prisma_migrations` table. When files disappear from `prisma/migrations/`, Prisma sees "applied but absent" entries.

**Rules:**
1. **Never delete migration files** that have been applied to any database. If you need to squash, use `prisma migrate diff` to generate a baseline and coordinate across all environments.
2. **Schema changes that require a migration** (adding/removing columns, changing types, new enums) must be created and committed in the same PR. Do NOT change `schema.prisma` without the corresponding migration file.
3. **If drift occurs**, the fix is `prisma migrate reset --force` on the local dev DB only — never on production. After reset, re-seed with `npm run db:seed`.
4. **For CI/production**, only `prisma migrate deploy` is used (via `vercel-build`). It applies migrations in order and never creates or deletes them.
5. **Prefer non-breaking schema changes** (e.g. adding nullable columns, adding new tables) that don't require data migration. Save breaking changes (type conversions, column renames) for dedicated PRs with tested migration SQL.

**Status:** Active rule. The `ConstraintEvent.entityType` column intentionally remains `String` (not an enum) to avoid requiring a migration for the code health sweep.
